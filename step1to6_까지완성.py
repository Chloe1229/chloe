import streamlit as st

def main():
    if 'page' not in st.session_state:
        st.session_state['page'] = 1
    page = st.session_state['page']

    st.title("MFDS 허가 후 제조방법 변경 자동화")

    if page == 1:
        st.header("Step 1. CTD 작성대상 완제의약품 해당 여부")
        step1 = st.radio(
            "제6조제1항에 따라 국제공통기술문서(CTD)로 작성하여 허가를 받거나 신고한 의약품의 제조원 또는 제조방법을 변경하는 경우에 해당합니까?",
            ("선택하세요", "예", "아니오"),
            key="step1_radio"
        )
        if step1 == "아니오":
            st.warning("""CTD 작성대상 완제의약품 해당여부를 확인하고, 해당시 먼저 CTD 3부 품질평가 자료(3.2.S.2 등) 심사 필요.
(근거 : 「의약품의 품목허가·신고·심사 규정」제6조, 제3조의2)""")
            st.stop()
        if step1 == "예":
            if st.button("다음단계로"):
                st.session_state['page'] = 2
                st.rerun()

    elif page == 2:
        st.header("Step 2. 제조방법 변경 항목 여부")
        step2 = st.radio(
            "제조에 관한 항목(CTD 제3부 품질평가 자료 중 3.2.S.2, 3.2.S.3, 3.2.P.2, 3.2.P.3, 3.2.P.4, 3.2.P.7)을 변경하는 경우에 해당합니까?",
            ("선택하세요", "예", "아니오"),
            key="step2_radio"
        )
        if step2 == "아니오":
            st.warning("""가이드라인 적용 대상에 해당하지 않습니다.
(근거 : 「의약품의 품목허가·신고·심사 규정」[별표 19])""")
            st.stop()
        if step2 == "예":
            if st.button("이전단계로"):
                st.session_state['page'] = 1
                st.rerun()
            if st.button("다음단계로"):
                st.session_state['page'] = 3
                st.rerun()

    elif page == 3:
        st.header("Step 3. 제조방법 CTD 적용(또는 전환) 품목 해당 여부")
        step3 = st.radio(
            "품목의 허가(신고) 사항 중 제조방법에 해당하는 자료(CTD 제3부 품질평가 자료 중 3.2.S.2, 3.2.S.3, 3.2.P.2, 3.2.P.3, 3.2.P.4, 3.2.P.7)를 국제공통기술문서(CTD)로 제출하여 심사받은 '제조방법 CTD 적용(또는 전환)' 품목에 해당합니까?",
            ("선택하세요", "예", "아니오"),
            key="step3_radio"
        )
        if step3 == "아니오":
            st.warning("""CTD 3부 품질평가 자료를 제출하여 제조방법 자료로서 심사받으시기 바랍니다.
(근거 : 「의약품의 품목허가·신고·심사 규정」[별표 19])""")
            st.stop()
        if step3 == "예":
            if st.button("이전단계로"):
                st.session_state['page'] = 2
                st.rerun()
            if st.button("다음단계로"):
                st.session_state['page'] = 4
                st.rerun()

    elif page == 4:
        st.header("Step 4. 변경사항에 해당하는 항목을 선택하세요.")
        categories = [
            ("3.2.S 원료의약품", None),
            ("3.2.S.1 일반정보", "3.2.S.1"),
            ("3.2.S.2 제조", "3.2.S.2"),
            ("3.2.P 완제의약품", None),
            ("3.2.P.1 완제의약품의 성상 및 조성", "3.2.P.1"),
            ("3.2.P.3 제조", "3.2.P.3"),
            ("3.2.P.4 첨가제의 관리", "3.2.P.4"),
            ("3.2.P.7 용기-마개 시스템", "3.2.P.7"),
            ("디자인스페이스(Design Space) 변경", "DS")
        ]
        step4_result = {}
        for name, code in categories:
            if code is None:
                st.markdown(f"**{name}**")
            else:
                sel = st.radio(
                    f"{name}",
                    ("변경 없음", "변경 있음"),
                    key=f"step4_{code}"
                )
                step4_result[code] = sel

        if st.button("이전단계로"):
            st.session_state['page'] = 3
            st.rerun()
        if st.button("다음단계로"):
            st.session_state['step4_result'] = step4_result
            st.session_state['page'] = 5
            st.rerun()

    elif page == 5:
        st.header("Step 5. 세부 변경항목을 선택하세요.")
        category_hierarchy = {
            "3.2.S.1": {"subs": [("1. 원료의약품 명칭변경", "title1")]},
            "3.2.S.2": {"subs": [
                ("2. 원료의약품의 제조소 또는 제조업자의 변경 또는 추가", "title2"),
                ("3. 원료의약품 제조 공정의 변경", "title3"),
                ("4. 원료의약품 제조 공정관리 규격의 변경", "title4"),
                ("5. 원료의약품 또는 중간체의 제조 규모 변경", "title5"),
                ("6. 원료의약품의 제조에 사용되는 원료(출발물질, 중간체, 용매, 시약 등)의 규격변경", "title6")
            ]},
            "3.2.P.1": {"subs": [
                ("7. 완제의약품 중 고형 제제의 조성 변경", "title7"),
                ("8. 고형제제의 코팅층 무게 변경", "title8"),
                ("9. 완제의약품(고형제제 제외)의 조성 변경", "title9"),
                ("10. 완제의약품(고형제제 제외)에 쓰이는 착색제 또는 착향제의 종류와 분량의 변경", "title10")
            ]},
            "3.2.P.3": {"subs": [
                ("11. 정성적 또는 정량적인 조성과 평균 질량의 변경이 없는 성상의 변경", "title11"),
                ("12. 완제의약품 제조공정의 일부 또는 전부에 대한 제조소 추가 또는 변경", "title12"),
                ("13. 비무균제제의 제조 규모 변경", "title13"),
                ("14. 무균제제의 제조 규모 변경", "title14"),
                ("15. 완제의약품의 제조공정 변경", "title15"),
                ("16. 완제의약품 또는 반제품의 제조에 적용되는 공정관리시험 또는 공정관리시험 기준(IPC)의 변경", "title16")
            ]},
            "3.2.P.4": {"subs": [
                ("17. 첨가제 기원의 변경", "title17"),
                ("18. 별규에 해당하는 첨가제의 규격 또는 시험방법 변경", "title18"),
                ("19. 식약처장이 인정하는 공정서 규격으로 첨가제 규격의 변경", "title19")
            ]},
            "3.2.P.7": {"subs": [
                ("20. 비무균제제의 직접용기 및 포장 재질, 종류 변경", "title20"),
                ("21. 무균제제의 직접용기 및 포장 재질, 종류 변경", "title21"),
                ("22. 직접 포장의 규격 변경", "title22"),
                ("23. 포장단위 변경", "title23"),
                ("24. 새로운 디자인스페이스 도입 또는 허가된 디자인스페이스의 확장", "title24")
            ]},
            "DS": {"subs": []}
        }
        step4_result = st.session_state.get('step4_result', {})
        targets = [code for code, sel in step4_result.items() if sel == "변경 있음"]
        step5_result = {}
        for code in targets:
            if code == "DS":
                st.markdown("**디자인스페이스(Design Space) 변경**")
                st.radio("디자인스페이스(Design Space) 변경", ("변경 있음",), index=0, disabled=True, key="step5_DS")
                step5_result[code] = "변경 있음"
            elif code in category_hierarchy:
                subs = category_hierarchy[code]['subs']
                for q_text, q_code in subs:
                    sel = st.radio(
                        f"{q_text}",
                        ("변경 없음", "변경 있음"),
                        key=f"step5_{q_code}"
                    )
                    step5_result[q_code] = sel
        if st.button("이전단계로"):
            st.session_state['page'] = 4
            st.rerun()
        if st.button("다음단계로"):
            st.session_state['step5_result'] = step5_result
            st.session_state['page'] = 6
            st.rerun()

step6_items = {
    "title1": {
        "항목명": "3.2.S 원료의약품\n3.2.S.1 일반정보\n1. 원료의약품 명칭변경",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 유효성분은 그대로 유지된다."
                ]
            }
        ]
    },
    "title2": {
        "항목명": "3.2.S 원료의약품\n3.2.S.2 제조\n2. 원료의약품의 제조소 또는 제조업자의 변경 또는 추가",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 2a. 원료의약품의 출발물질 생산",
                    "2. 2b. 원료의약품의 중간체 생산",
                    "3. 2c. 원료의약품의 생산"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 무균 원료의약품이 아니다.",
                    "2. 변경된 제조소의 원료의약품은 완제연계심사로서 DMF 품질심사를 완료하였다.",
                    "3. 원료의약품 규격에는 변경이 없다.",
                    "4. 출발 물질의 규격, 불순물 프로파일 및 합성경로는 변경이 없다.",
                    "5. 규격(공정 중 관리, 모든 원료의 분석 방법 포함), 제조 방법, 상세한 합성 경로 및 중간체 규격의 변경이 없다.",
                    "6. 원료의약품의 경우, 그 결정형이 동일하고, 입자크기가 중요한 경우 입자 크기 분포에 유의한 차이가 없다.",
                    "7. 원료의약품의 규격 (공정 중 관리, 모든 원료의 분석 방법 포함), 제조 방법 (배치 크기 포함) 및 상세한 합성 경로는 변경이 없다.",
                    "8. 사람 또는 동물 유래 물질이 사용되는 경우, BSE/TSE(소해면상뇌증/전염성해면상뇌증) 위험에 대한평가가 필요한 새로운 공급자를 이용하지 않는다.",
                    "9. 출발물질은 조품의 원료, 등록대상 원료의약품의 성분, 등록하고자 하는 원료의약품과 화학구조가 유사한 성분(염류, 이성체 등)에 해당하지 않는다.",
                    "10. 실제 제조장소의 변경이 없는 제조소의 명칭 변경이다(인수합병에 의한 상호변경 포함)."
                ]
            }
        ]
    },
    "title3": {
        "항목명": "3.2.S 원료의약품\n3.2.S.1 일반정보\n3. 원료의약품 제조 공정의 변경",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 원료의약품의 물리적 성질(결정형, 비결정형 등)에 변경이 없다",
                    "2. 난용성 원료의약품의 경우, 결정다형이 동일하고, 입자 크기가 중요한 경우 입자 크기 분포에 유의한 차이가 없다.",
                    "3. 사람 또는 동물 유래 물질이 사용되는 경우, 바이러스 안정성 평가 및 BSE/TSE(소해면상뇌증/전염성해면상뇌증) 위험에 대한평가가 필요한 새로운 공정이 포함되지 않는다.",
                    "4. 합성경로의 변경이 없고(중간체는 동일하게 유지됨) 새로운 시약, 촉매 혹은 용매가 사용되지 않는다.",
                    "5. 원료의약품의 정성적 및 정량적 불순물 프로파일이나 물리 화학적 성질의 변경이 없다.",
                    "6. 무균 원료의약품의 멸균 또는 무균 공정에 영향을 미치지 않는다.",
                    "7. 최종 중간체 이전 공정의 변경이다.",
                    "8. 변경 전·후, 출발물질 규격, 중간체 규격 또는 원료의약품 규격의 변경이 없다.",
                    "9. 원료의약품 규격에 변경이 없다"
                ]
            }
        ]
    },
    "title4": {
        "항목명": "3.2.S 원료의약품\n3.2.S.2 제조\n4. 원료의약품 제조 공정관리 규격의 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 4a. 공정관리 기준 강화",
                    "2. 4b. 공정관리 시험 및 기준 추가",
                    "3. 4c. 안전성이나 품질 문제로 인한 공정",
                    "4. 관리 시험의 추가 또는 교체",
                    "5. 4d. 공정관리 시험 삭제",
                    "6. 4e. 공정관리 시험 기준 완화"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 해당 변경은 제조 중 예기치 않은 사례로 발생한 것이 아니다. (예: 안전성이 미확인된 새로운 불순물 확인 또는 총 불순물 기준의 변경 등)",
                    "2. 해당 변경은 현재 승인된 기준 범위 내에 있다.",
                    "3. 분석 절차는 동일하다. (분석절차의 경미한 변경은 허용)",
                    "4. 삭제되는 공정관리 시험은 품질에 영향을 미치지 않는다.",
                    "5. 해당 변경은 무균 원료의약품의 멸균 공정에 영향을 주지 않는다"
                ]
            }
        ]
    },
    "title5": {
        "항목명": "3.2.S 원료의약품\n3.2.S.2 제조\n5. 원료의약품 또는 중간체의 제조 규모 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 5a. 제조 규모의 10배 이하 확대",
                    "2. 5b. 제조 규모의 축소",
                    "3. 5c. 제조 규모의 10배 초과 확대"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 제조방법 및 공정관리의 변경은 제조규모 변경에 따른 변경만을 포함한다.",
                    "2. 제조 공정의 재현성에 영향이 없다.",
                    "3. 제조과정에서 예상하지 못한 사유로 기준을 충족하지 못한 경우 또는 안정성 문제 때문에 발생한 변경이 아니다."
                ]
            }
        ]
    },
    "title6": {
        "항목명": "3.2.S 원료의약품\n3.2.S.2 제조\n6. 원료의약품의 제조에 사용되는 원료(출발물질, 중간체, 용매, 시약 등)의 규격변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 6a. 규격 기준의 강화",
                    "2. 6b. 시험방법의 변경",
                    "3. 6c. 기준 및 시험방법 추가",
                    "4. 6d. 기준 또는 시험방법의 삭제",
                    "5. 6e. 안전성이나 품질관리 문제로 인한 기준의 추가 또는 교체",
                    "6. 6f. 원료약품(용매, 시약, 촉매 등)에 대한 기준 완화",
                    "7. 6g. 원료의약품 출발물질 및 핵심중간체(조품원료, 등록대상 원료의약품성분, 원료의약품과 화학구조가 유사한 성분 등)에 대한 기준 완화"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 제조과정에서 예상하지 못한 사유로 기준을 충족하지 못한 경우 또는 안정성 문제 때문에 발생한 변경이 아니다.",
                    "2. 모든 변경 사항은 현재의 허용 기준범위 내에 있다.",
                    "3. 시험방법의 변경은 없다.",
                    "4. 변경 후 시험방법은 동일한 분석 기술 또는 원리로 수행된다.",
                    "5. 변경 후 시험법 밸리데이션은 적절하게 수행되었으며, 이전 시험방법과 동등 이상이다.",
                    "6. 원료의약품의 총 불순물 기준 변경은 없으며, 새로 검출되는 불순물은 없다.",
                    "7. 변경은 유전독성 불순물의 관리전략에 영향을 미치지 않는다.",
                    "8. 변경되는 시험항목은 중요하지 않거나 승인된 대체 시험항목이 있다.",
                    "9. 회수용매의 기준과 관련되어 있지 않다."
                ]
            }
        ]
    },
    "title7": {
        "항목명": "3.2.P 완제의약품\n3.2.P.1 완제의약품의 성상 및 조성\n7. 완제의약품 중 고형 제제의 조성 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 7a. 타르색소(황색4호 제외)의 종류 변경",
                    "2. 7b. 착색제 또는 착향제의 종류 및 분량 변경",
                    "3. 7c. 첨가제의 종류 및 분량 변경"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 제형의 기능적 특성 및 제품 품질(붕해시간 혹은 용출프로파일 등)에 미치는 영향은 없다.",
                    "2. 단위제형 총 중량 중 착색제, 착향제간의 함유율의 차는 없으며, 기허가 품목(동일투여경로)에 사용된 예가 있다.",
                    "3. 해당 변경은 안정성 문제로 인한 것이 아니며, 또한 잠재적인 안전성 우려, 즉 용량 간의 구별 문제를 야기하지 않는다.",
                    "4. 변경/추가되는 첨가제는 「의약품의 품목허가·신고·심사 규정」 제25조제2항제1호에 따른 새로운 첨가제가 아니다.",
                    "5. 변경/추가되는 첨가제의 규격은 공정서 규격에 해당한다."
                ]
            }
        ]
    },
    "title8": {
        "항목명": "3.2.P 완제의약품\n3.2.P.1 완제의약품의 성상 및 조성\n8. 고형제제의 코팅층 무게 변경",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": [],
                "항목": [
                    "N/A"
                ]
            }
        ]
    },
    "title9": {
        "항목명": "3.2.P 완제의약품\n3.2.P.1 완제의약품의 성상 및 조성\n9. 완제의약품(고형제제 제외)의 조성 변경",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 시럽제, 엘릭서제, 틴크제 등 경구용 액제(유제 및 현탁제 등은 제외) 및 외용액제(「의약품의 품목허가·신고·심사 규정」 제27조제3항제1호).",
                    "2. 주사제, 점안제, 점이제로 원료약품의 종류가 이미 허가·신고사항과 동일하거나 다음의 첨가제가 다른 경우(동 규정 제27조제3항제2호).\n - 주사제: 보존제, 완충제, 항산화제, pH조절제(이미 허가·신고된 주사제에 사용된 pH조절제에 한함)\n - 점안제/점이제: 보존제, 완충제, 등장화제, 점도조절제, pH조절제",
                    "3. 흡입 전신마취제(동 규정 제27조제3항제3호)",
                    "4. 액제를 제외한 국소적용 외용제제로서 원료약품의 종류가 이미 허가·신고사항과 동일하거나 다음의 첨가제가 다른 경우(동 규정 제27조제3항제4호)\n - 보존제, 항산화제, 착색제, 착향제",
                    "5. 유효성분을 기체나 증기 등의 흡입제로 투여하는 것으로서 국소요법만을 목적으로 하는 제제(동 규정 제27조제3항제5호)",
                    "6. 수액제, 혈액증량제 및 인공관류액제제(동 규정 제27조제3항제6호)",
                    "7. 폐에 적용하는 흡입제(동 규정 제27조제5항제1호 단서조항)",
                    "8. 충족조건 1~7 제외",
                    "9. 변경/추가되는 첨가제는 「의약품의 품목허가·신고·심사 규정」 제25조제2항제1호에 따른 새로운 첨가제가 아니다."
                ]
            }
        ]
    },
    "title10": {
        "항목명": "3.2.P 완제의약품\n3.2.P.1 완제의약품의 성상 및 조성\n10. 완제의약품(고형제제 제외)에 쓰이는 착색제 또는 착향제의 종류와 분량의 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 10a. 타르색소의 종류 변경(황색4호 제외)",
                    "2. 10b. 타르색소의 종류 및 분량 변경",
                    "3. 10c. 타르색소 외 착색제, 착향제의 변경"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 제형의 성능에 관한 시험결과(예: 붕해시간 및 용출프로파일)에 변화가 없다.",
                    "2. 총 중량을 유지하기 위해 완제의약품의 처방 조성 중 주요 부분을 이루고 있는 첨가제를 써서 처방 조성이 경미하게 조정되어 있다.",
                    "3. 완제의약품의 규격은 성상, 냄새 및/또는 맛에 관해서만 개정되어 있거나, 관련되는 경우, 확인시험이 삭제되거나 추가되어 있다.",
                    "4. 타르색소 착색제(황색 4호 제외)를 사용하는 경우 종류 및 분량은 「의약품등의 타르색소 지정과 기준 및 시험방법」(식약처 고시)에 적합하다.",
                    "5. 착향제는 기허가 품목(동일 투여경로)에 사용된 예가 있다.",
                    "6. 변경/추가되는 첨가제는 국제공통기술문서 3.2.P.4를 준수하고 있다.",
                    "7. 사람 또는 동물 유래 물질이 사용되는 경우, 출처가 새로운 원료약품에 대한 BSE/TSE(소해면상뇌증/전염성해면상뇌증) 위해 적합성 평가 자료가 있다.",
                    "8. 변경 사항은 용량간의 식별에 영향을 미치지 않는다.",
                    "9. 변경/추가되는 첨가제는 「의약품의 품목허가·신고·심사 규정」 제25조제2항제1호에 따른 새로운 첨가제가 아니다."
                ]
            }
        ]
    },
    "title11": {
        "항목명": "3.2.P 완제의약품\n3.2.P.3 제조\n11. 정성적 또는 정량적인 조성과 평균 질량의 변경이 없는 성상의 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 11a. 11b에 언급된 것 이외의 정제, 캡슐, 좌제",
                    "2. 11b. 장용성, 서방성 완제의약품"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 완제의약품의 규격은 완제의약품의 모양에 대해서만 변경되어 있다.",
                    "2. 변경 전·후 최소 1배치(파일럿 배치 이상)의 용출 프로파일(기준 및 시험방법 시험액에서 측정)은 동등하다.",
                    "3. 성형과정의 변경에 따른 모양 및/또는 크기의 변경이 있다. ※ (식별표시를 위한 변경(잉크, 그림, 글자체 등) 제외)"
                ]
            }
        ]
    },
    "title12": {
        "항목명": "3.2.P 완제의약품\n3.2.P.3 제조\n12. 완제의약품 제조공정의 일부 또는 전부에 대한 제조소 추가 또는 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 12a. 이차 포장 제조소",
                    "2. 12b.1. 일차 포장 제조소 – 고형(정제, 캡슐제), 반고형(연고제, 크림제) 및 액상 제제",
                    "3. 12b.2. 일차 포장 제조소 – 그 밖의 액상 제제(유제, 현탁제)",
                    "4. 12c1. 원료칭량 공정 및 완제품 포장공정 제조소를 제외한 그 밖의 모든 제조소",
                    "5. 12c2. 기타 제조소(조합 상황 등, 표 참조)"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 배치 조성, 제조 공정 및 공정 관리의 기록 사항, 장비 등급 및 공정 관리, 주요 공정 및 반제품의 관리 또는 완제의약품 규격에 있어서 변경이 없다.",
                    "2. (해당하는 경우) 해당 품목을 제조하는 제조소에 ‘의약품 등의 안전에 관한 규칙’ 제48조의2에 따른 제조 및 품질관리기준 적합판정서가 있거나, 해외 제조원인 경우 제4조제1항제4호에 따른 유효기간 내의 제조증명서가 있다.",
                    "3. 무균제제가 아니다.",
                    "4. 포장 재질의 변경이 없다.",
                    "5. 액상제제(경구용 액제, 주사제, 점안제, 점이제 등)¹), 폐에 적용하는 흡입제 및 반고형제제에 해당한다. (¹유제 및 현탁제 제외)"
                ]
            }
        ]
    },
    "title13": {
        "항목명": "3.2.P 완제의약품\n3.2.P.3 제조\n13. 비무균제제의 제조 규모 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 13a. 뱃치 생산규모(의동기준 제3조의2제5항의 대조약과 의약품동등성을 입증하거나 임상시험을 실시한 제제) 대비 10배수 이하의 변경",
                    "2. 13b. 일반 제제에서 10배 초과의 생산 규모 변경",
                    "3. 13c. 제형의 특수성이 인정되는 제제¹) 및 반고형제제에서 10배 초과의 생산규모 변경"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 해당 변경은 제제의 재현성 및/또는 일관성에 영향을 미치지 않는다.",
                    "2. 제조장비의 작동원리 및 디자인이 동일하고, 제조 방법 및/또는 공정 중 관리의 변경은 제조 규모의 변경에 따른 변경만 필요로 한다.",
                    "3. (위험도 평가에 따른) 제조 공정 밸리데이션 실시 계획서가 있거나 또는 현재의 밸리데이션 실시 계획서에 따라 생산 규모의 3배치에 대한 제조 공정 밸리데이션이 성공적으로 수행되었다.",
                    "4. 해당 변경은 제조 과정에서 발생하는 예기치 않은 사례 혹은 안정성 문제로 인하여 필요로 하는 것이 아니다.",
                    "5. 일반제제에 해당한다(장용성 및 방출조절제제, 서방성제제 등 제형의 특수성이 인정되는 제제 제외).",
                    "6. 액상제제(경구용 액제, 외용액제, 점안제, 점이제 등)"
                ]
            }
        ]
    },
    "title14": {
        "항목명": "3.2.P 완제의약품\n3.2.P.3 제조\n14. 무균제제의 제조 규모 변경",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 해당 변경은 생산 일관성에 영향을 주지 않는다.",
                    "2. 원료약품 및 그 분량에는 변경이 없다.",
                    "3. 의약품의 규격 변경이 없다.",
                    "4. (위험도 평가에 따른) 밸리데이션 실시 계획서가 있거나 또는 현재의 밸리데이션 실시 계획서에 따라 생산 규모의 3배치에 대한 제조 밸리데이션이 성공적으로 수행되었다.",
                    "5. 액상제제(주사제, 점안제, 점이제 등)로서 제조 규모 변경이 10배 초과이다.",
                    "6. 제형의 특수성이 인정되는 제제, 반고형제제 또는 분말형 주사제로서 제조 규모 변경이 10배 초과이다."
                ]
            }
        ]
    },
    "title15": {
        "항목명": "3.2.P 완제의약품\n3.2.P.3 제조\n15. 완제의약품의 제조공정 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 15a. 완제의약품의 제조공정 변경",
                    "2. 15b-1. 완제의약품의 제조공정 변경 (예: 용출에 영향을 주는 첨가제 등급 변경, 결합액의 용매 양 변경, 용출에 영향을 주는 첨가제의 투입순서 변경, 코팅액의 용매 변경 등)",
                    "3. 15b-2. 완제의약품의 제조공정 변경 (예: 결합액의 용매 종류 변경 등)",
                    "4. 15c. 완제의약품의 제조공정 변경"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 불순물 프로파일의 변경이 없고 물리 화학적 성질에 변경이 없다. 용출 프로파일은 대조약 배치의 프로파일과 유사하다.",
                    "2. 변경 전·후 제제의 제조공정은 동일한 원리이고 반제품은 동일하며, 공정에 사용되는 제조 용매에는 변경이 없다(습식 조립법에서 건식 조립법으로의 변경, 직접 분말 압축법에서 습식 또는 건식 과립 압축법으로의 변경, 또는 그 반대로의 변경은 제조 원리의 변경으로 간주된다).",
                    "3. 변경 전·후 작동원리가 같은 동일 계열의 제조장비를 사용한다.(제조장비의 작동원리 및 디자인의 동일 여부는 [부록 1], [부록 2]를 참고한다.)",
                    "4. 완제의약품의 품질에 영향을 미치는 제조공정(주요공정) 조건의 변동이 없다.",
                    "5. 반제품 또는 완제의약품의 규격 변경은 없다.",
                    "6. 제조 중에 발생하는 예기치 않은 사례로 인한 규격 미충족 또는 안정성 문제 때문에 발생한 변경은 아니다.",
                    "7. 해당 변경은 계량 및/또는 전달 기능을 제공하는 일차 포장과 관련된 포장이나 라벨링 공정을 포함하지 않는다.",
                    "8. 일반제제에 해당한다(장용성 및 방출조절제제, 서방성제제 등 제형의 특수성이 인정되는 제제 제외).",
                    "9. 액상제제(경구용 액제, 주사제, 점안제, 점이제 등)에 해당한다."
                ]
            }
        ]
    },
    "title16": {
        "항목명": "3.2.P 완제의약품\n3.2.P.3 제조\n16. 완제의약품 또는 반제품의 제조에 적용되는 공정관리시험 또는 공정관리시험 기준(IPC)의 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 16a. 공정관리시험 기준의 변경",
                    "2. 16b. 공정관리시험 기준의 변경(보고유형: Cmaj)",
                    "3. 16c. 공정관리시험 항목의 삭제",
                    "4. 16d. 새로운 공정관리시험 기준의 추가",
                    "5. 16e. 공정관리시험 방법의 변경"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 해당 변경은 공정관리 기준(예, 마손도, 경도, 입도, 밀도, 수분 등) 범위 내에 있다.",
                    "2. 해당 변경은 제조 중에 발생하는 예기치 않은 사례로 인한 규격 미충족 또는 안정성 문제로 인하여 필요로 하는 것이 아니다.",
                    "3. 삭제된 공정관리 항목은 불필요하거나 생략 가능한 것으로 입증되었으며, 제제의 주요 품질 특성(예: 혼합균일성, 질량편차)에 미치는 영향이 없거나 적다.",
                    "4. 시험방법에는 변경이 없다."
                ]
            }
        ]
    },
    "title17": {
        "항목명": "3.2.P 완제의약품\n3.2.P.4 첨가제의 관리\n17. 첨가제 기원의 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 17a. 동물성 기원에서 식물 또는 합성 기원의 원료로 변경",
                    "2. 17b. 식물 또는 합성 기원에서 동물성 기원, 또는 동물성 원료의 다른 동물성 기원으로 변경"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 첨가제와 완제의약품의 규격에는 변경이 없다."
                ]
            }
        ]
    },
    "title18": {
        "항목명": "3.2.P 완제의약품\n3.2.P.4 첨가제의 관리\n18. 별규에 해당하는 첨가제의 규격 또는 시험방법 변경",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 해당 변경은 제조 과정에서 발생하는 예기치 않은 사례로 인한 규격 미충족 혹은 안정성 문제 때문에 발생한 변경은 아니다."
                ]
            }
        ]
    },
    "title19": {
        "항목명": "3.2.P 완제의약품\n3.2.P.4 첨가제의 관리\n19. 식약처장이 인정하는 공정서 규격으로 첨가제 규격의 변경",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 공정서를 준수하기 위해 요구되는 규격 이외에는 변경이 없다(예: 입자 크기 분포의 변경 없음)."
                ]
            }
        ]
    },
    "title20": {
        "항목명": "3.2.P 완제의약품\n3.2.P.7 용기-마개 시스템\n20. 비무균제제의 직접용기 및 포장 재질, 종류 변경",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 고형제제로서 주성분, 제형, 투여경로가 동일한 기허가 의약품에서 사용례가 확인되는 용기 재질로의 변경 또는 용기포장 종류는 동일하고 보호성이 동등이상인 재질로의 변경으로, 기허가의약품의 사용(유효)기간을 초과하지 않는다."
                ]
            }
        ]
    },
    "title21": {
        "항목명": "3.2.P 완제의약품\n3.2.P.7 용기-마개 시스템\n21. 무균제제의 직접용기 및 포장 재질, 종류 변경",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 변경 후 용기의 보호성 등이 동등 이상이고 상호작용 위험이 없다."
                ]
            }
        ]
    },
    "title22": {
        "항목명": "3.2.P 완제의약품\n3.2.P.7 용기-마개 시스템\n22. 직접 포장의 규격 변경",
        "선택사항": [
            {
                "명칭": "변경 하위항목",
                "선택옵션": ["변경 있음", "변경 없음"],
                "항목": [
                    "1. 22a. 규격 기준의 강화",
                    "2. 22b. 시험 항목의 추가 또는 삭제"
                ]
            },
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 모든 변경 사항은 현재의 허용 기준범위 내에 있다.",
                    "2. 해당 변경은 제조 과정에서 발생하는 예기치 않은 사례로 인한 규격 미충족 혹은 안정성 문제 때문에 발생한 변경이 아니다."
                ]
            }
        ]
    },
    "title23": {
        "항목명": "3.2.P 완제의약품\n3.2.P.7 용기-마개 시스템\n23. 포장단위 변경",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": ["충족", "미충족"],
                "항목": [
                    "1. 해당 변경은 제조 과정에서 발생하는 예기치 않은 사례로 인한 규격 미충족 혹은 안정성 문제 때문에 발생한 변경이 아니다.",
                    "2. 이외 허가사항의 변경은 없다."
                ]
            }
        ]
    },
    "title24": {
        "항목명": "3.2.P 완제의약품\n3.2.P.7 용기-마개 시스템\n24. 새로운 디자인스페이스 도입 또는 허가된 디자인스페이스의 확장",
        "선택사항": [
            {
                "명칭": "충족요건",
                "선택옵션": [],
                "항목": [
                    "N/A"
                ]
            }
        ]
    }
}

def show_step6():
    st.header("Step 6. 변경세부항목별 선택사항/충족요건 체크")
    step5_result = st.session_state.get('step5_result', {})
    selected_titles = [t for t, sel in step5_result.items() if sel == "변경 있음"]
    all_results = {}
    for title in selected_titles:
        항목 = step6_items.get(title)
        if not 항목:
            continue
        st.subheader(f"{title}: {항목['항목명']}")
        code_results = {}
        for 선택사항 in 항목.get("선택사항", []):
            st.markdown(f"**{선택사항['명칭']}**")
            for 문장 in 선택사항["항목"]:
                if 선택사항["선택옵션"]:
                    선택 = st.radio(
                        문장,
                        선택사항["선택옵션"],
                        key=f"{title}_{선택사항['명칭']}_{문장}"
                    )
                    code_results[f"{선택사항['명칭']}_{문장}"] = {'내용': 문장, '결과': 선택}
                else:
                    st.markdown(문장)
        all_results[title] = code_results

    if st.button("이전단계로"):
        st.session_state['page'] = 5
        st.rerun()
    if st.button("다음단계로"):
        st.session_state['step6_result'] = all_results
        st.session_state['page'] = 7
        st.rerun()

if __name__ == "__main__":
    if 'page' not in st.session_state:
        st.session_state['page'] = 1
    if st.session_state['page'] == 6:
        show_step6()
    elif st.session_state['page'] == 7:
        show_step7()
    else:
        main()

